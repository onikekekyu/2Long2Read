apiVersion: v1
kind: ConfigMap
metadata:
  name: cgu-analysis-dag
  namespace: airflow
data:
  cgu_analysis_dag_working.py: |
    """
    DAG Airflow pour l'analyse des Terms & Conditions Spotify - FIXED VERSION
    Utilise KubernetesPodOperator pour une intÃ©gration correcte avec Airflow UI
    """
    import pendulum
    from datetime import timedelta
    from airflow.models.dag import DAG
    from airflow.providers.cncf.kubernetes.operators.pod import KubernetesPodOperator
    from airflow.operators.bash import BashOperator

    default_args = {
        'owner': '2long2read',
        'depends_on_past': False,
        'email_on_failure': False,
        'email_on_retry': False,
        'retries': 1,
        'retry_delay': timedelta(minutes=2),
    }

    with DAG(
        dag_id="spotify_cgu_analysis",
        default_args=default_args,
        description="Analyse des CGU Spotify avec Claude AI via KubernetesPodOperator",
        schedule=None,
        start_date=pendulum.datetime(2025, 1, 1, tz="UTC"),
        catchup=False,
        tags=["2long2read", "spotify", "production"],
    ) as dag:

        # Task 1: Analyser les Terms & Conditions Spotify
        analyze_spotify = KubernetesPodOperator(
            task_id="analyze_spotify_terms",
            name="spotify-cgu-worker",
            namespace="airflow",
            image="2long2read-worker:latest",
            image_pull_policy="IfNotPresent",
            cmds=["sh", "-c"],
            arguments=[
                """
                set -e

                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "ğŸµ ANALYSE SPOTIFY TERMS & CONDITIONS"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

                # GÃ©nÃ©rer un task ID unique
                TASK_ID="spotify-$(date +%Y%m%d-%H%M%S)"
                echo "ğŸ“‹ Task ID: $TASK_ID"

                # CrÃ©er le contenu depuis la variable d'environnement
                echo "$SPOTIFY_CONTENT" | head -c 10000 > /tmp/spotify_terms.txt
                CONTENT=$(cat /tmp/spotify_terms.txt)
                CONTENT_LENGTH=$(echo "$CONTENT" | wc -c)

                echo "ğŸ“„ Contenu chargÃ©: $CONTENT_LENGTH caractÃ¨res"
                echo ""

                # ExÃ©cuter l'analyse
                echo "ğŸš€ Lancement de l'analyse..."
                python3 /app/worker.py \
                  --task-id "$TASK_ID" \
                  --source-name "spotify" \
                  --text-content "$CONTENT"

                EXIT_CODE=$?

                if [ $EXIT_CODE -eq 0 ]; then
                    echo ""
                    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                    echo "âœ… ANALYSE TERMINÃ‰E AVEC SUCCÃˆS"
                    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                    echo "ğŸ’¾ Task ID: $TASK_ID"
                    echo "ğŸ“Š RÃ©sultats sauvegardÃ©s dans MongoDB"
                    echo "ğŸ“ˆ Consultez Grafana pour la visualisation"
                else
                    echo ""
                    echo "âŒ ERREUR: L'analyse a Ã©chouÃ© (code: $EXIT_CODE)"
                    exit $EXIT_CODE
                fi
                """
            ],
            env_vars={
                "MONGO_HOSTNAME": "mongo-service.default.svc.cluster.local",
                "MONGO_PORT": "27017",
                "ANTHROPIC_API_KEY": "{{ var.value.get('ANTHROPIC_API_KEY', '') }}",
                "SPOTIFY_CONTENT": """Terms and Conditions of Use - Spotify. Last Updated: August 26, 2025. THESE TERMS CONTAIN A MANDATORY ARBITRATION PROVISION THAT REQUIRES THE USE OF ARBITRATION ON AN INDIVIDUAL BASIS TO RESOLVE DISPUTES, RATHER THAN JURY TRIALS OR CLASS ACTIONS. You hereby grant to Spotify a non-exclusive, transferable, sublicensable, royalty-free, fully paid, irrevocable, worldwide license to reproduce, make available, perform and display, translate, modify, create derivative works from, distribute, and otherwise use any such User Content through any medium. We reserve the right to terminate your account at any time without notice or refund. You waive your right to participate in class action lawsuits. Any disputes will be resolved through binding arbitration in our jurisdiction. We may change these terms at any time without notification.""",
            },
            get_logs=True,
            is_delete_operator_pod=True,
            in_cluster=True,
            startup_timeout_seconds=600,
            execution_timeout=timedelta(minutes=12),
        )

        # Task 2: RÃ©cupÃ©rer et afficher les rÃ©sultats depuis MongoDB
        get_results = BashOperator(
            task_id="get_mongodb_results",
            bash_command="""
            set -e

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ’¾ RÃ‰CUPÃ‰RATION DES RÃ‰SULTATS MONGODB"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            # RÃ©cupÃ©rer le pod MongoDB
            MONGO_POD=$(kubectl get pods -n default -l app=mongo -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")

            if [ -z "$MONGO_POD" ]; then
                echo "âš ï¸  Pod MongoDB non trouvÃ©"
                echo "   Les rÃ©sultats sont sauvegardÃ©s et visibles dans Grafana"
                exit 0
            fi

            echo "ğŸ“¦ Pod MongoDB: $MONGO_POD"
            echo ""
            echo "ğŸ” Recherche de la derniÃ¨re analyse Spotify..."
            echo ""

            kubectl exec "$MONGO_POD" -n default -- \
                mongosh too_long_to_read --quiet --eval '
                var doc = db.analytic_reports.find({"source_name": "spotify"}).sort({"_id": -1}).limit(1).toArray()[0];
                if (doc) {
                    print("âœ… Analyse trouvÃ©e!");
                    print("");
                    print("ğŸ“‹ Task ID: " + doc.task_id);
                    print("ğŸ“Š Status: " + doc.status);
                    print("");
                    print("ğŸ¯ SCORES DE RISQUE:");
                    print("  â”œâ”€ Overall Risk: " + doc.report.risk_scores.overall + "/100");
                    print("  â”œâ”€ Data Privacy: " + doc.report.risk_scores.data_privacy + "/100");
                    print("  â”œâ”€ User Rights: " + doc.report.risk_scores.user_rights + "/100");
                    print("  â”œâ”€ Legal Protection: " + doc.report.risk_scores.legal_protection + "/100");
                    print("  â”œâ”€ Termination Risk: " + doc.report.risk_scores.termination_risk + "/100");
                    print("  â””â”€ Transparency: " + doc.report.risk_scores.transparency + "/100");
                    print("");
                    print("ğŸ”´ Clauses dangereuses: " + doc.report.dangerous_clauses.length);
                } else {
                    print("âŒ Aucune analyse Spotify trouvÃ©e");
                }
                ' 2>&1 || echo "âš ï¸  Erreur lors de la rÃ©cupÃ©ration"

            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… Analyse complÃ¨te"
            echo "ğŸ“Š Consultez Grafana: http://localhost:3000"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            """,
            execution_timeout=timedelta(minutes=2),
        )

        # DÃ©finir les dÃ©pendances
        analyze_spotify >> get_results
